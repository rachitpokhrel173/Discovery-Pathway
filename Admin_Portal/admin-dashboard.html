<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Discovery Pathway ‚Äì Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


    <style>
        :root {
            --bg: #f6f7fb;
            --card: #fff;
            --text: #0f172a;
            --muted: #6b7280;
            --line: #e5e7eb;
            --brand: #6c5ce7;
            --brand2: #8b5cf6;
            --success: #10b981;
            --warn: #f59e0b;
        }

        * { box-sizing: border-box }
        html, body { height: 100% }
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh
        }

        /* Sidebar */
        .sidebar { width: 270px; background: #1f2233; color: #e5e7eb; border-right: 1px solid #2c2f45; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh }
        .brand { display: flex; align-items: center; gap: .75rem; padding: 18px 16px; border-bottom: 1px solid #2c2f45 }
        .logo { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, var(--brand), var(--brand2)); display: grid; place-items: center; color: #fff; font-weight: 700 }
        .brand h1 { font-size: 1.05rem; margin: 0 }
        .nav { padding: 10px }
        .nav a { display: flex; align-items: center; gap: .75rem; padding: .7rem .9rem; border-radius: 12px; color: #cbd5e1; text-decoration: none; transition: .15s }
        .nav a:hover { background: #2c2f45; color: #fff }
        .nav a.active { background: linear-gradient(135deg, rgba(108, 92, 231, .25), rgba(139, 92, 246, .25)); color: #fff }
        .hamburger { display: none }

        /* Main */
        .main { flex: 1; min-width: 0; padding: 22px 26px }
        .topbar { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 18px }
        .leftbar { display: flex; align-items: center; gap: 10px }
        .search { flex: 1; min-width: 200px; max-width: 560px; display: flex; align-items: center; gap: .5rem; background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: .6rem .8rem }
        .search input { border: 0; outline: 0; width: 100%; font: inherit }
        .btn { background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; border: 0; padding: .6rem .9rem; border-radius: 12px; cursor: pointer }
        .btn:disabled { opacity: .6; cursor: not-allowed }
        .ghost { background: #fff; border: 1px solid var(--line); color: var(--text) }
        .avatar { width: 36px; height: 36px; border-radius: 999px; background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; display: grid; place-items: center; font-weight: 700; user-select: none }

        /* KPI */
        .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 18px }
        .kpi-card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px }
        .kpi { display: flex; align-items: center; justify-content: space-between }
        .kpi .n { font-size: 1.9rem; font-weight: 700 }
        .kpi h3 { margin: 0 0 .4rem 0; color: var(--muted); font-size: .92rem }
        .pill { display: inline-flex; align-items: center; gap: .4rem; padding: .25rem .55rem; border-radius: 999px; font-size: .73rem }
        .pill.green { background: rgba(16, 185, 129, .12); color: #047857 }
        .pill.amber { background: rgba(245, 158, 11, .12); color: #92400e }

        /* Grid & cards */
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; width: 100%; max-width: 100%; overflow: hidden }
        #pieChart { max-width: 250px; max-height: 250px; margin: 0 auto }
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px }
        .card h3 { margin: .2rem 0 .7rem 0; font-size: .98rem; color: var(--muted) }
        .big { grid-column: span 8 }
        .side { grid-column: span 4 }
        .list { list-style: none; margin: 0; padding: 0 }
        .row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--line) }
        .muted { color: var(--muted) }

        /* Table */
        .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap }
        .input, select.input { border: 1px solid var(--line); background: #fff; border-radius: 10px; padding: .55rem .7rem; font: inherit }
        table { width: 100%; border-collapse: collapse }
        th, td { padding: 12px 10px; border-bottom: 1px solid var(--line); text-align: left }
        th { font-weight: 600; color: var(--muted) }
        .actions { display: flex; gap: 8px }
        .icon-btn { border: 1px solid var(--line); background: #fff; padding: .35rem .5rem; border-radius: 8px; cursor: pointer }
        .icon-btn.danger { border-color: #fecaca; color: #b91c1c; background: #fff }

        /* FAB + Modal */
        .fab { position: fixed; right: 22px; bottom: 22px; width: 58px; height: 58px; border-radius: 999px; background: linear-gradient(135deg, var(--brand), var(--brand2)); color: #fff; border: 0; cursor: pointer; font-size: 28px; box-shadow: 0 14px 28px rgba(108, 92, 231, .35) }
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, .45); display: none; align-items: center; justify-content: center; padding: 20px }
        .modal.open { display: flex }
        .modal-card { width: 100%; max-width: 460px; background: #fff; border-radius: 16px; border: 1px solid var(--line); padding: 18px }
        .modal-card h3 { margin: 0 0 10px 0 }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px }

        /* Sections */
        .section { display: none }
        .section.active { display: block }

        /* Responsive */
        @media (max-width:1200px) { .big { grid-column: span 7 } .side { grid-column: span 5 } }
        @media (max-width:1050px) { .big { grid-column: 1/-1 } .side { grid-column: 1/-1 } .kpis { grid-template-columns: repeat(2, 1fr) } }
        @media (max-width:780px) {
            .sidebar { position: fixed; left: -270px; transition: .2s; z-index: 50 }
            .sidebar.open { left: 0 }
            .hamburger { display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--line); background: #fff; cursor: pointer }
            .main { padding: 18px }
            .kpis { grid-template-columns: 1fr }
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" aria-label="Main navigation">
        <div class="brand">
            <div class="logo">DP</div>
            <h1>Discovery Pathway</h1>
        </div>
        <nav class="nav" id="nav">
            <a href="#" data-section="dashboard" class="active">üè† <span>Dashboard</span></a>
            <a href="#" data-section="ielts">üìù <span>IELTS</span></a>
            <a href="#" data-section="pte">üéß <span>PTE</span></a>
            <a href="#" data-section="japanese">üà∫ <span>Japanese</span></a>
            <a href="#" data-section="students">üë• <span>All Students</span></a>
        </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <header class="topbar">
            <div class="leftbar">
                <button class="hamburger" id="menuBtn" aria-label="Toggle menu">‚ò∞</button>
                <div class="search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Zm10 2-4.35-4.35" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <input id="globalSearch" type="search" placeholder="Search students by name or phone‚Ä¶" aria-label="Global search" />
                </div>
            </div>

            <div class="rightbar" style="display:flex;align-items:center;gap:15px;position:relative;">
                <button class="btn ghost" id="exportBtn">Export CSV</button>
                <input type="file" id="uploadExcel" accept=".xlsx,.xls" style="display:none" />
                <button class="btn ghost" id="uploadBtn">Upload Excel</button>

                <script>
                    // Trigger hidden file input
                    document.getElementById("uploadBtn").addEventListener("click", () => {
                        document.getElementById("uploadExcel").click();
                    });

                    // Handle Excel upload
                    document.getElementById("uploadExcel").addEventListener("change", async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        try {
                            const data = await file.arrayBuffer();
                            const workbook = XLSX.read(data, { type: "array" });

                            // Take first sheet only
                            const sheetName = workbook.SheetNames[0];
                            const sheet = workbook.Sheets[sheetName];

                            // Convert to JSON (each row becomes an object)
                            const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                            let imported = 0;

                            rows.forEach(r => {
                                // Flexible mapping: try by header, else fallback to column order
                                const values = Object.values(r);

                                const name = r.Name || r["Student Name"] || r["Full Name"] || values[0] || "";
                                const phone = r.Phone || r.Number || r["Contact"] || values[1] || "";
                                let course = r.Course || detectCourseFromFilename(file.name) || "IELTS";
                                const parent = r.Parent || r["Parent Phone"] || values[2] || "";
                                const remarks = r.Remarks || values[3] || "";

                                // Normalize course to one of the 3 buckets so charts don't break
                                course = normalizeCourse(course);

                                if (!name && !phone) return; // skip empty rows

                                students.push({
                                    id: uuid(),
                                    name: String(name).trim(),
                                    course,
                                    phone: String(phone).trim(),
                                    parent: String(parent).trim(),
                                    remarks: String(remarks).trim(),
                                    createdAt: Date.now()
                                });

                                imported++;
                            });

                            if (imported > 0) {
                                saveStudents(students);
                                fullRender();
                                alert(`${imported} students imported from Excel`);
                            } else {
                                alert("No valid student data found in this Excel file.");
                            }

                        } catch (err) {
                            console.error(err);
                            alert("Error reading Excel file. Please check format.");
                        }

                        // reset file input so you can re-upload the same file if needed
                        e.target.value = "";
                    });

                    // Helper: detect course from filename (ielts/pte/japanese)
                    function detectCourseFromFilename(filename) {
                        const f = filename.toLowerCase();
                        if (f.includes("ielts")) return "IELTS";
                        if (f.includes("pte")) return "PTE";
                        if (f.includes("japan")) return "Japanese";
                        return "IELTS";
                    }
                </script>


                <!-- Profile Dropdown -->
                <div class="profile-menu" style="position:relative;">
                    <button id="profileBtn" class="avatar" aria-haspopup="menu" aria-expanded="false" title="Open profile">DP</button>
                    <div id="profileDropdown" role="menu" style="display:none;position:absolute;right:0;top:110%;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1);min-width:180px;z-index:100;">
                        <div style="padding:10px 15px;border-bottom:1px solid #f3f4f6;">
                            <div id="profileName" style="font-weight:600;">Admin</div>
                            <div id="profileEmail" class="muted" style="font-size:12px;">banpa@discoveryedu.com.np</div>
                        </div>
                        <a href="#" id="menuProfile" role="menuitem" style="display:block;padding:10px 15px;color:#374151;text-decoration:none;font-size:14px;">Profile</a>
                        <a href="#" id="menuSettings" role="menuitem" style="display:block;padding:10px 15px;color:#374151;text-decoration:none;font-size:14px;">Settings</a>
                        <button id="logoutBtn" role="menuitem" style="width:100%;text-align:left;padding:10px 15px;font-size:14px;border:none;background:none;cursor:pointer;color:#dc2626;">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="kpis" id="kpis"></div>

            <div class="grid">
                <div class="card side">
                    <div class="kpi">
                        <h3>Student Growth (last 6 months)</h3>
                        <span class="muted" id="lineMeta"></span>
                    </div>
                    <canvas id="lineChart" height="120" aria-label="Student growth line chart"></canvas>
                </div>

                <div class="card side">
                    <h3>Course Distribution</h3>
                    <canvas id="pieChart" height="220" aria-label="Course distribution pie chart"></canvas>
                    <ul class="list" id="distLegend" style="margin-top:10px"></ul>
                </div>

                <div class="card side">
                    <h3>Recent Students</h3>
                    <ul class="list" id="recentList"></ul>
                </div>
            </div>
        </section>

        <!-- IELTS -->
        <section id="ielts" class="section">
            <div class="card">
                <div class="toolbar">
                    <input class="input" id="ieltsSearch" placeholder="Search IELTS students‚Ä¶" aria-label="Search IELTS" />
                </div>
                <ul class="list" id="ieltsList"></ul>
            </div>
        </section>

        <!-- PTE -->
        <section id="pte" class="section">
            <div class="card">
                <div class="toolbar">
                    <input class="input" id="pteSearch" placeholder="Search PTE students‚Ä¶" aria-label="Search PTE" />
                </div>
                <ul class="list" id="pteList"></ul>
            </div>
        </section>

        <!-- Japanese -->
        <section id="japanese" class="section">
            <div class="card">
                <div class="toolbar">
                    <input class="input" id="japSearch" placeholder="Search Japanese students‚Ä¶" aria-label="Search Japanese" />
                </div>
                <ul class="list" id="japList"></ul>
            </div>
        </section>

        <!-- ALL STUDENTS -->
        <section id="students" class="section">
            <div class="card">
                <div class="toolbar">
                    <input class="input" id="tableSearch" placeholder="Search by name, course or phone" aria-label="Filter table" />
                    <select class="input" id="courseFilter" aria-label="Filter by course">
                        <option value="">All Courses</option>
                        <option>IELTS</option>
                        <option>PTE</option>
                        <option>Japanese</option>
                    </select>
                </div>
                <div style="overflow:auto;">
                    <table aria-label="All students">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Phone</th>
                                <th>Parent</th>
                                <th>Remarks</th>
                                <th>Added</th>
                                <th style="width:110px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- FAB + MODAL (Add/Edit) -->
    <button class="fab" id="fab" title="Add student">+</button>

    <div class="modal" id="modal" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <h3 id="modalTitle">Add Student</h3>
            <form id="studentForm">
                <div class="form-grid">
                    <input class="input" id="sName" placeholder="Full name" autocomplete="name" required />
                    <select class="input" id="sCourse">
                        <option>IELTS</option>
                        <option>PTE</option>
                        <option>Japanese</option>
                    </select>
                    <input class="input" id="sPhone" placeholder="Phone number" inputmode="numeric" autocomplete="tel" required />
                    <input class="input" id="sParent" placeholder="Parent phone" inputmode="numeric" autocomplete="tel" />
                    <input class="input" id="sRemarks" placeholder="Remarks (optional)" />
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn" id="saveStudent">Save</button>
                    <button type="button" class="btn ghost" id="closeModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* ========= Helpers & Persistence ========= */
        const STORAGE_KEY = 'dp_students_v2';

        function uuid() {
            // Guard for older browsers where crypto may be missing
            if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16);
            });
        }

        // Normalize course names so charts & filters don't break
        function normalizeCourse(v) {
            const s = String(v || '').trim().toLowerCase();
            if (s.startsWith('pte')) return 'PTE';
            if (s.startsWith('japan')) return 'Japanese';
            return 'IELTS';
        }

        const seed = [
            { id: uuid(), name: 'Umanga Lamichhane', course: 'IELTS', phone: '9849576186', parent: '', remarks: 'Australia ‚Äì regular classes join', createdAt: Date.now() - 86400000 * 30 },
            { id: uuid(), name: 'Bishal Dhungana', course: 'IELTS', phone: '9762604951', parent: '', remarks: 'South Korea ‚Äì regular classes but required to meet tomorrow', createdAt: Date.now() - 86400000 * 29 },
            { id: uuid(), name: 'Pragati Tamang', course: 'IELTS', phone: '9704484583', parent: '', remarks: 'South Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 28 },
            { id: uuid(), name: 'Samir Shrestha', course: 'IELTS', phone: '9705782462', parent: '', remarks: 'South Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 27 },
            { id: uuid(), name: 'Shreeyasebi Shrestha', course: 'IELTS', phone: '9828491580', parent: '', remarks: 'Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 26 },
            { id: uuid(), name: 'Ashok Devkota', course: 'IELTS', phone: '9842783318', parent: '', remarks: 'Australia/Canada ‚Äì regular classes', createdAt: Date.now() - 86400000 * 25 },
            { id: uuid(), name: 'Manish Adhikari', course: 'IELTS', phone: '9749492990', parent: '', remarks: 'Canada/South Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 24 },
            { id: uuid(), name: 'Anil Tamang', course: 'IELTS', phone: '9803814659', parent: '', remarks: 'Australia ‚Äì regular classes', createdAt: Date.now() - 86400000 * 23 },
            { id: uuid(), name: 'Binita Ghimire', course: 'IELTS', phone: '9765038103', parent: '', remarks: 'South Korea ‚Äì gradesheet missing ‚Äì regular classes', createdAt: Date.now() - 86400000 * 22 },
            { id: uuid(), name: 'Bidhya Malla', course: 'IELTS', phone: '9808328353', parent: '', remarks: 'South Korea ‚Äì gradesheet missing ‚Äì regular classes', createdAt: Date.now() - 86400000 * 21 },
            { id: uuid(), name: 'Shreejana Biswokarma', course: 'IELTS', phone: '9767236256', parent: '', remarks: 'South Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 20 },
            { id: uuid(), name: 'Jensiha Timalsina', course: 'IELTS', phone: '9768768090', parent: '', remarks: 'Australia ‚Äì regular classes', createdAt: Date.now() - 86400000 * 19 },
            { id: uuid(), name: 'Sanjani Thakuri', course: 'IELTS', phone: '9863622206', parent: '', remarks: 'Korea ‚Äì gradesheet missing ‚Äì regular classes join', createdAt: Date.now() - 86400000 * 18 },
            { id: uuid(), name: 'Aashiya Suwal', course: 'IELTS', phone: '9862641190', parent: '', remarks: 'Australia ‚Äì regular classes', createdAt: Date.now() - 86400000 * 17 },
            { id: uuid(), name: 'Amrit Dahal', course: 'IELTS', phone: '9745304253', parent: '', remarks: 'UK ‚Äì regular classes', createdAt: Date.now() - 86400000 * 16 },
            { id: uuid(), name: 'Samir Manandhar', course: 'IELTS', phone: '9813797479', parent: '', remarks: 'Australia/South Korea ‚Äì regular join required to meet', createdAt: Date.now() - 86400000 * 15 },
            { id: uuid(), name: 'Niru Kumari Shah', course: 'IELTS', phone: '9808048394', parent: '', remarks: 'Busan, South Korea ‚Äì payment garaune ‚Äì regular classes', createdAt: Date.now() - 86400000 * 14 },
            { id: uuid(), name: 'Sadhana Baniya', course: 'IELTS', phone: '9761739618', parent: '', remarks: 'Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 13 },
            { id: uuid(), name: 'Sumit Kafle', course: 'IELTS', phone: '9761788302', parent: '', remarks: 'Korea ‚Äì just started classes', createdAt: Date.now() - 86400000 * 12 },
            { id: uuid(), name: 'Sumir Dong Tamang', course: 'IELTS', phone: '9863623128', parent: '', remarks: 'Korea ‚Äì passport received', createdAt: Date.now() - 86400000 * 11 },
            { id: uuid(), name: 'Dev Jung Neupane', course: 'IELTS', phone: '', parent: '', remarks: 'Australia', createdAt: Date.now() - 86400000 * 10 },
            { id: uuid(), name: 'Dilasha Basnet', course: 'IELTS', phone: '9808986590', parent: '', remarks: 'Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 9 },
            { id: uuid(), name: 'Nabin Lama', course: 'IELTS', phone: '9810315052', parent: '', remarks: 'Korea', createdAt: Date.now() - 86400000 * 8 },
            { id: uuid(), name: 'Babi Kumari Timalsina', course: 'IELTS', phone: '9763499628', parent: '', remarks: 'South Korea ‚Äì regular classes', createdAt: Date.now() - 86400000 * 7 },
            { id: uuid(), name: 'Sarita Tamang', course: 'IELTS', phone: '9762691771', parent: '', remarks: 'Australia ‚Äì regular classes', createdAt: Date.now() - 86400000 * 6 },
            { id: uuid(), name: 'Jalan Thapa Magar', course: 'IELTS', phone: '9746288765', parent: '', remarks: '', createdAt: Date.now() - 86400000 * 5 },
            { id: uuid(), name: 'Sumit Dahal', course: 'IELTS', phone: '9767654165', parent: '', remarks: 'Australia', createdAt: Date.now() - 86400000 * 4 },
            { id: uuid(), name: 'Sundari Thing Tamang', course: 'IELTS', phone: '9742554128', parent: '', remarks: 'Australia', createdAt: Date.now() - 86400000 * 3 },
            { id: uuid(), name: 'Sabina Budathoki', course: 'IELTS', phone: '', parent: '', remarks: '', createdAt: Date.now() - 86400000 * 2 },
        ];


        function loadStudents() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                const list = raw ? JSON.parse(raw) : seed;
                return Array.isArray(list) ? list.map(s => ({ ...s, course: normalizeCourse(s.course) })) : seed;
            } catch { return seed }
        }
        function saveStudents(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

        let students = loadStudents();
        let editingId = null;

        /* ========= Shortcuts ========= */
        const $ = (q, r = document) => r.querySelector(q);
        const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
        const fmtDate = ts => new Date(ts).toLocaleDateString();

        /* ========= Sidebar (mobile) ========= */
        const sidebar = $('#sidebar');
        $('#menuBtn')?.addEventListener('click', () => { sidebar.classList.toggle('open'); });
        // close sidebar when clicking a nav on mobile
        $('#nav')?.addEventListener('click', e => { if (e.target.closest('a')) sidebar.classList.remove('open'); });

        /* ========= Navigation ========= */
        $$('#nav a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                $$('#nav a').forEach(n => n.classList.remove('active'));
                a.classList.add('active');
                const id = a.dataset.section;
                $$('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(id)?.classList.add('active');
            });
        });

        /* ========= Profile Dropdown ========= */
        const profileBtn = $('#profileBtn');
        const dropdown = $('#profileDropdown');
        const logoutBtn = $('#logoutBtn');
        const admin = { name: 'Discovery Admin', email: 'banpa@discoveryedu.com.np', photo: '' };

        function renderAvatar(user) {
            const initials = user.name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() || 'A';
            profileBtn.textContent = initials;
            if (user.photo) {
                profileBtn.style.backgroundImage = `url(${user.photo})`;
                profileBtn.style.backgroundSize = 'cover';
                profileBtn.style.backgroundPosition = 'center';
                profileBtn.textContent = '';
            }
            $('#profileName').textContent = user.name || 'Admin';
            $('#profileEmail').textContent = user.email || '';
        }
        renderAvatar(admin);

        function toggleDropdown(show) {
            dropdown.style.display = show ? 'block' : 'none';
            profileBtn.setAttribute('aria-expanded', show ? 'true' : 'false');
        }
        profileBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown(dropdown.style.display !== 'block'); });
        window.addEventListener('click', (e) => { if (!dropdown.contains(e.target)) toggleDropdown(false); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleDropdown(false); });
        logoutBtn.addEventListener('click', () => { alert('Logging out...'); window.location.href = '/index.html'; });

        /* ========= Charts ========= */
        let pie, line;

        function countByCourse() {
            return students.reduce((acc, s) => {
                const key = normalizeCourse(s.course); // ensure consistent bucket
                acc[key] = (acc[key] || 0) + 1; return acc;
            }, { IELTS: 0, PTE: 0, Japanese: 0 });
        }

        function buildCharts() {
            const counts = countByCourse();
            const dataArr = ['IELTS', 'PTE', 'Japanese'].map(k => counts[k] || 0);

            pie?.destroy();
            pie = new Chart($('#pieChart'), {
                type: 'doughnut',
                data: { labels: ['IELTS', 'PTE', 'Japanese'], datasets: [{ data: dataArr }] },
                options: { cutout: '60%', plugins: { legend: { display: false } } }
            });

            // legend
            const UL = $('#distLegend'); UL.innerHTML = '';
            ['IELTS', 'PTE', 'Japanese'].forEach(c => {
                const li = document.createElement('li'); li.className = 'row';
                li.innerHTML = `<span>${c}</span><span class="muted">${counts[c] || 0}</span>`;
                UL.appendChild(li);
            });

            // Line: last 6 months
            const now = new Date();
            const labels = [];
            const series = new Array(6).fill(0);
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(d.toLocaleString(undefined, { month: 'short' }));
            }
            students.forEach(s => {
                const dt = new Date(s.createdAt);
                const diffMonths = (now.getFullYear() - dt.getFullYear()) * 12 + (now.getMonth() - dt.getMonth());
                const idx = 5 - diffMonths;
                if (idx >= 0 && idx < 6) series[idx]++;
            });

            line?.destroy();
            line = new Chart($('#lineChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'New Students', data: series, tension: .35, fill: false }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
            $('#lineMeta').textContent = `${series.reduce((a, b) => a + b, 0)} added`;
        }

        /* ========= Renderers ========= */
        function renderKPIs() {
            const c = countByCourse(); const total = students.length;
            const data = [
                { label: 'Total Students', value: total, pill: `<span class="pill green">+${Math.max(1, Math.floor(total / 3))} new</span>` },
                { label: 'IELTS', value: c.IELTS, pill: `<span class="pill amber">${c.IELTS} active</span>` },
                { label: 'PTE', value: c.PTE, pill: `<span class="pill amber">${c.PTE} active</span>` },
                { label: 'Japanese', value: c.Japanese, pill: `<span class="pill amber">${c.Japanese} active</span>` }
            ];
            const wrap = $('#kpis'); wrap.innerHTML = '';
            data.forEach(k => {
                const el = document.createElement('div'); el.className = 'kpi-card';
                el.innerHTML = `<div class="kpi"><div><h3>${k.label}</h3><div class="n">${k.value}</div></div><div>${k.pill}</div></div>`;
                wrap.appendChild(el);
            });
        }

        function renderRecent() {
            const UL = $('#recentList'); UL.innerHTML = '';
            students.slice(-6).reverse().forEach(s => {
                const li = document.createElement('li'); li.className = 'row';
                li.innerHTML = `<div><strong>${s.name}</strong> <span class="muted">‚Ä¢ ${s.course}</span></div><div class="muted">${fmtDate(s.createdAt)}</div>`;
                UL.appendChild(li);
            });
        }

        function renderCourseList(course, root) {
            root.innerHTML = '';
            students.filter(s => normalizeCourse(s.course) === course).slice().reverse().forEach(s => {
                const li = document.createElement('li'); li.className = 'row';
                li.innerHTML = `<div><strong>${s.name}</strong> <span class="muted">${String(s.phone || '')}</span></div><span class="muted">${s.remarks || ''}</span>`;
                root.appendChild(li);
            });
        }

        function renderTable(list = students) {
            const TB = $('#tableBody'); TB.innerHTML = '';
            list.slice().reverse().forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${s.name}</td>
          <td>${normalizeCourse(s.course)}</td>
          <td>${String(s.phone || '')}</td>
          <td>${s.parent || ''}</td>
          <td>${s.remarks || ''}</td>
          <td>${fmtDate(s.createdAt)}</td>
          <td>
            <div class="actions">
              <button class="icon-btn" data-action="edit" data-id="${s.id}">Edit</button>
              <button class="icon-btn danger" data-action="del" data-id="${s.id}">Delete</button>
            </div>
          </td>`;
                TB.appendChild(tr);
            });
        }

        function fullRender() {
            renderKPIs();
            buildCharts();
            renderRecent();
            renderCourseList('IELTS', $('#ieltsList'));
            renderCourseList('PTE', $('#pteList'));
            renderCourseList('Japanese', $('#japList'));
            renderTable();
        }

        /* ========= Add / Edit / Delete ========= */
        const modal = $('#modal');
        const form = $('#studentForm');

        function openModal(mode = 'add') {
            $('#modalTitle').textContent = mode === 'add' ? 'Add Student' : 'Edit Student';
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => $('#sName').focus(), 0);
        }
        function closeModal() {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            editingId = null;
            form.reset();
            $('#sCourse').value = 'IELTS';
        }

        $('#fab').addEventListener('click', () => openModal('add'));
        $('#closeModal').addEventListener('click', closeModal);
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        window.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });

        // Table actions via delegation
        $('#tableBody').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.dataset.action === 'edit') openEdit(id);
            if (btn.dataset.action === 'del') deleteStudent(id);
        });

        function openEdit(id) {
            const s = students.find(x => x.id === id);
            if (!s) return;
            editingId = id;
            $('#sName').value = s.name;
            $('#sCourse').value = normalizeCourse(s.course);
            $('#sPhone').value = String(s.phone || '');
            $('#sParent').value = s.parent || '';
            $('#sRemarks').value = s.remarks || '';
            openModal('edit');
        }

        function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            students = students.filter(s => s.id !== id);
            saveStudents(students);
            fullRender();
        }

        // Save (Add/Edit) ‚Äì submit handler (supports Enter key)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const s = {
                name: $('#sName').value.trim(),
                course: normalizeCourse($('#sCourse').value),
                phone: $('#sPhone').value.trim(),
                parent: $('#sParent').value.trim(),
                remarks: $('#sRemarks').value.trim(),
            };
            if (!s.name || !s.phone) { alert('Name and phone are required'); return; }
            if (!/^\d[\d\s\-+()]*$/.test(s.phone)) { if (!confirm('Phone seems invalid. Save anyway?')) return; }

            if (editingId) {
                students = students.map(row => row.id === editingId ? { ...row, ...s } : row);
            } else {
                students.push({ id: uuid(), ...s, createdAt: Date.now() });
            }
            saveStudents(students);
            fullRender();
            closeModal();
        });

        /* ========= Search & Filters ========= */
        // Header quick search filters table
        $('#globalSearch').addEventListener('input', e => {
            const q = e.target.value.toLowerCase();
            const filtered = students.filter(s =>
                [String(s.name).toLowerCase(), normalizeCourse(s.course).toLowerCase(), String(s.phone), String(s.remarks || '').toLowerCase()].some(v => v.includes(q))
            );
            renderTable(filtered);
        });

        // Course page search
        function wireCourseSearch(inputEl, course, listEl) {
            inputEl.addEventListener('input', () => {
                const q = inputEl.value.toLowerCase();
                const filtered = students.filter(s =>
                    normalizeCourse(s.course) === course &&
                    (String(s.name).toLowerCase().includes(q) || String(s.phone).includes(q) || String(s.remarks || '').toLowerCase().includes(q))
                );
                listEl.innerHTML = '';
                filtered.slice().reverse().forEach(s => {
                    const li = document.createElement('li'); li.className = 'row';
                    li.innerHTML = `<div><strong>${s.name}</strong> <span class="muted">${String(s.phone || '')}</span></div><span class="muted">${s.remarks || ''}</span>`;
                    listEl.appendChild(li);
                });
            });
        }
        wireCourseSearch($('#ieltsSearch'), 'IELTS', $('#ieltsList'));
        wireCourseSearch($('#pteSearch'), 'PTE', $('#pteList'));
        wireCourseSearch($('#japSearch'), 'Japanese', $('#japList'));

        // All students table filter
        function filterTable() {
            const q = $('#tableSearch').value.toLowerCase();
            const course = $('#courseFilter').value;
            const filtered = students.filter(s =>
                (!course || normalizeCourse(s.course) === course) &&
                [String(s.name).toLowerCase(), normalizeCourse(s.course).toLowerCase(), String(s.phone), String(s.remarks || '').toLowerCase()].some(v => v.includes(q))
            );
            renderTable(filtered);
        }
        $('#tableSearch').addEventListener('input', filterTable);
        $('#courseFilter').addEventListener('change', filterTable);

        /* ========= Export CSV ========= */
        $('#exportBtn').addEventListener('click', () => {
            const rows = [['Name', 'Course', 'Phone', 'Parent', 'Remarks', 'Added'],
            ...students.map(s => [s.name, normalizeCourse(s.course), String(s.phone || ''), s.parent || '', s.remarks || '', new Date(s.createdAt).toISOString()])];
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'students.csv'; a.click();
            URL.revokeObjectURL(url);
        });

        /* ========= Initial Render ========= */
        fullRender();
    </script>
</body>

</html>
